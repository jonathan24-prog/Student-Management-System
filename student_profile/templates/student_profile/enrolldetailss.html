{% extends 'student_profile/basemenu.html' %}


{%block content%}

<div id="app">


    <el-form :ref="enroll" :model="enroll" size="small" label-position="top">
        <el-card>
            <h6>Enrollment Form</h6>
            <br>
            <el-row :gutter="5">
                <el-col :md="8">
                    <el-form-item label="Fullname">
                        <el-select  filterable style="width: 100%;" placeholder="select a student"
                            v-model="enroll.student">
                            <el-option v-for="(item, index) in students" :label="item.fullname" :value="item.id"
                                :key="index"></el-option>

                        </el-select>
                    </el-form-item>

                </el-col>
                <el-col :md="8">
                    <el-form-item label="Course">
                        <el-select placeholder="select a course" style="width: 100%;" v-model="enroll.course">
                            <el-option v-for="(item, index) in courses" :label="item.code" :value="item.id"
                                :key="index"></el-option>

                        </el-select>
                    </el-form-item>
                </el-col>
                <el-col :md="8">
                    <el-form-item label="Major">
                        <el-select filterable style="width: 100%;" placeholder="select a major" v-model="enroll.major">
                            <el-option v-for="(item, index) in majors" :label="item.name" :value="item.id" :key="index">
                            </el-option>

                        </el-select>
                    </el-form-item>

                </el-col>
                <el-col :md="8">
                    <el-form-item label="Year Level">
                        <el-select placeholder="select a year level" style="width: 100%;" v-model="enroll.year_level">
                            <el-option v-for="(item, index) in yearlevels" :label="item.description" :value="item.id"
                                :key="index"></el-option>

                        </el-select>
                    </el-form-item>
                </el-col>
                <el-col :md="8">
                    <el-form-item label="Semister">
                        <el-select placeholder="select a semister" style="width: 100%;" v-model="enroll.semister">
                            <el-option v-for="(item, index) in semisters" :label="item" :value="item" :key="index">
                            </el-option>

                        </el-select>
                    </el-form-item>
                </el-col>
                <el-col :md="8">
                    <el-form-item label="Academic Year">
                        <el-select placeholder="select academic year" style="width: 100%;"
                            v-model="enroll.academic_year">
                            <el-option v-for="(item, index) in ays" :label="item.ay" :value="item.id" :key="index">
                            </el-option>

                        </el-select>
                    </el-form-item>
                </el-col>

            </el-row>
        </el-card>
        <el-card>
            <div slot="header" class="clearfix">
                <span>Subjects</span>
                <el-button style="float: right;"             :disabled='enroll.status=="forwarded" || enroll.status=="approved"' @click="getSubjects" size="small" round type="danger">Add Subjects on
                    curriculum</el-button>
            </div>

            <el-row :gutter="10">
                <el-col :md="20">
                <v-select v-model="subject" label="full" value="id" :options="subjects"></v-select>
                
                </el-col>
                <el-col :md="4">
                    <el-button size="small"             :disabled='enroll.status=="forwarded" || enroll.status=="approved"' @click="addSubject" style="width: 100%;" type="primary">add</el-button>
                </el-col>
            </el-row>
            <hr>
   

            <el-table
            v-loading="loading"
            element-loading-text="Loading..."
            element-loading-spinner="el-icon-loading"
            element-loading-background="rgba(0, 0, 0, 0.1)"
            :data="enroll.enroll_subjects"
            style="width: 100%">
            <el-table-column
            prop="sub.code"
            label="Code"
            width="100"
             >
            </el-table-column>
            <el-table-column
            prop="sub.description"
            label="Descriptive Title"
              >
            </el-table-column>
            <el-table-column
            prop="sub.unit"
            label="Unit">
            </el-table-column>
            <el-table-column
            prop="status"
            label="status">
            </el-table-column>
       
            <el-table-column

      label="action"
      width="120">
      <template slot-scope="scope">
        <el-button
            :disabled='scope.row.status=="forwarded"'
          @click.native.prevent="deleteRow(scope.$index, enroll.enroll_subjects,scope.row.id)"
          type="danger"
          size="small">
          Remove
        </el-button>
      </template>
    </el-table-column>
          </el-table>
          <br>
          <el-button :disabled="enroll.status =='forwarded' || enroll.status=='approved' " @click="save" size="small"  type="success">forward for approval</el-button>
        </el-card>
      
    </el-form>







</div>
<style>
    .el-form-item--small .el-form-item__content,
    .el-form-item--small .el-form-item__label {
        line-height: 0px;
    }

    .style-chooser .vs__search::placeholder,
  .style-chooser .vs__dropdown-toggle,
  .style-chooser .vs__dropdown-menu {
    background: #dfe5fb;
    border: none;
    color: #394066;
    text-transform: lowercase;
    font-variant: small-caps;
  }

  .style-chooser .vs__clear,
  .style-chooser .vs__open-indicator {
    fill: #394066;
  }
</style>
{%endblock%}



{%block script%}
<!-- import Vue before Element -->

<script>
    const enroll_id={{enroll.id}}
    Vue.use(VueTables.ClientTable);
    ELEMENT.locale(ELEMENT.lang.en)
    Vue.component('v-select', VueSelect.VueSelect);

    const axios_instance = axios.create({
        baseURL: '/bccapi',
        timeout: 10000,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': Cookies.get('csrftoken')
        }
    })

    const axios_instance1 = axios.create({
        baseURL: '/',
        timeout: 10000,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': Cookies.get('csrftoken')
        }
    })
    new Vue({
        el: '#app',
        data() {
            return {
                students: [],
                ays: [],
                majors: [],
                courses: [],
                subject: null,
                instructors: [],
                subjects: [],
                yearlevels: [],
                semisters: ["1st", "2nd", "summer"],
                loading:true,

                enroll: {

                    student: '',
                    course: null,
                    major: null,
                    academic_year: null,
                    year_level: null,
                    semister: "",
                    status: "forwarded",
                    enroll_subjects: []
                }
            }
        },
        methods: {
            deleteRow(index, rows,id) {
            axios_instance.delete('subjectsenrolled/'+id+'/').then(res=>{
                console.log(res.data)
                 rows.splice(index, 1);
            })
            
      },
            addSubject(){
                //let subject=this.subjects.find(el=>el.id == this.subject.id)

                console.log(this.subject)
           
                if(this.enroll.enroll_subjects.find(e=>e.subject == this.subject) == null){
                    this.enroll.enroll_subjects.push(
                            {
                             
                                grade_status: null,
                                grade: null,
                                status: "draft",
                                subject: this.subject.id,
                                instructor: null,
                                sub:this.subject
                            }
                        )
                }
     
            },
            save(){
    
         console.log(this.enroll)
                        this.enroll.status='forwarded'
                        this.enroll.enroll_subjects.forEach(el=>{
                            el.status='forwarded'
                        })
                        axios_instance.put('enrolls/'+this.enroll.id+'/',this.enroll).then(result=>{
                            console.log(result.data)
                            //window.location.replace(`/student/${result.data.id}/enroll/`);
                            this.$notify({
                                title: 'Success',
                                message: 'Forward Successfully',
                                type: 'success'
                              });
                        })
                   
                    
            
           
            },
            getSubjects() {

                let major = this.enroll.major != null ? this.enroll.major : "0"
                axios_instance1.get(`/Apiaddsubjectbycuriculum/${this.enroll.course}/${major}/${this.enroll.semister}/${this.enroll.year_level}`).then(res => {
                    console.log(res.data)
                    //this.enroll.enroll_subjects=[]
                    res.data.forEach(el => {
                        if(this.enroll.enroll_subjects.find(e=>e.subject== el.id)== null){
                            this.enroll.enroll_subjects.push(
                            {
                             
                                grade_status: null,
                                grade: null,
                                status: "draft",
                                subject: el.id,
                                instructor: null,
                                sub:el
                            },
                        )
                        }
                        else{
                            console.log('already added')
                        }
                        
                    })
                }).catch(err=>{
                 this.$message.error('Oops, No Curriculum added on this parameters');
                })
            }

        },
        created() {
        
            
              axios_instance.get('curriculumss').then(res => {
                    res.data.forEach(el=>{
                    el.subjects.forEach(e=>{
                        if(this.subjects.find(sub=>sub.id == e.id) == null){
                            this.subjects.push(e)
                        }
                        
                        })
                 
                })
           
 
                this.subjects.forEach(el => {
                    el.full = `${el.code}-${el.description}`
                });
        

          

                axios_instance.get('enrolls/'+enroll_id).then(ress => {
                this.enroll = ress.data
                console.log(this.enroll)
          
                this.enroll.enroll_subjects.forEach(el=>{
                    let subject=this.subjects.find(e=>e.id == el.subject)
                    console.log(subject)
                    el.sub=subject
                })

                this.loading=false

                axios_instance.get('students/'+this.enroll.student).then(ress => {
                    this.students.push(ress.data)
                    this.students.forEach(el => {
                        el.fullname = `${el.last_name}, ${el.first_name}`
                    })
                
                })

             
            })
            })

         

            axios_instance.get('instructors').then(res => {
                this.instructors = res.data
                console.log(res.data)

            })
            axios_instance.get('majors').then(res => {
                this.majors = res.data
                console.log(res.data)
            })
            axios_instance.get('ays').then(res => {
                this.ays = res.data
                console.log(res.data)
            })
            axios_instance.get('courses').then(res => {
                this.courses = res.data
                console.log(res.data)
            })
            axios_instance.get('yearlevels').then(res => {
                this.yearlevels = res.data
                console.log(res.data)
            })
     
        },
    })
</script>
{%endblock%}

</html>